
# 哨兵（sentinel）机制

redis高可用的保证机制，用于监控 Redis 主从节点的状态，并在发现节点故障时自动进行主从切换，确保 Redis 服务的高可用性。

在哨兵机制中，redis有一些节点作为哨兵节点，负责监控所有Redis节点的状态，当一个redis主节点出现宕机的时候，哨兵会向所有的其他的哨兵节点发送通知，选取一个哨兵节点作为主哨兵，由这个主哨兵进行故障转移，并选择一个新的redis主节点，使得新的主节点接管原来主节点的工作，从而保证redis服务的高可用性。



# 集群

Redis的集群模式是通过将数据分散存储在多个节点上来实现高可用和水平扩展的一种方式。Redis集群采用的是无中心节点的分布式架构，所有节点都是对等的。在Redis集群中，数据被划分为16384个哈希槽，每个节点负责一部分哈希槽。当一个客户端连接到Redis集群时，它可以向任意一个节点发送命令，由该节点负责转发命令到正确的节点上

在 Redis cluster 架构下，每个 Redis 要放开两个端口号，比如一个是 6379，另外一个就是 加 1w 的端口号，比如 16379。

16379 端口号是用来进行节点间通信的，节点通信采用的协议：gossip 协议，用于节点间进行高效的数据交换（信息包括**故障信息**，**节点的增加和删除**，**hash slot** 信息等等），占用更少的网络带宽和处理时间。

## redis集群的工作原理

Redis集群的工作原理如下：

1.  哈希槽分配：当一个新节点加入集群时，它会从其他节点中获取一部分哈希槽，并开始负责这些哈希槽上的数据。
    
2.  数据分片：每个键值对被分配到一个哈希槽上，每个节点负责一部分哈希槽上的数据。
    
3.  节点间通信：每个节点都会和其他节点建立连接，并且节点之间会周期性地交换集群状态信息。
    
4. **主从复制**：每个节点都可以有多个从节点，从节点会复制主节点上的数据。
    
5.  故障转移：当一个节点下线或者发生故障时，集群会自动将该节点负责的哈希槽重新分配给其他节点，并且选择一个从节点晋升为主节点，确保数据的高可用性。

## 集群扩容的时候，各个节点是如何通信的

在redis集群进行扩容的时候，会在新的节点中创建出和旧节点相同的槽位，并将新的节点加入到集群中，此时其他的节点与新的节点进行建立TCP链接，然后集群会讲旧节点移动到新节点上，节点之间通过gossip协议进行消息广播和信息的同步，确保集群中各个节点状态的一致性。


## 为什么 



