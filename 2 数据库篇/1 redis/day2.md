# 过期策略

### Redis 过期策略

Redis 过期策略是：**定期删除+惰性删除**。

**定期删除**：
	Redis 默认是每隔 100ms 就**随机抽取**一些设置了过期时间的 key，检查其是否过期，如果过期就删除。

**惰性删除：**
	在获取某个 key 的时候，Redis 会检查一下 ，这个 key 如果设置了过期时间那么是否过期了？如果过期了此时就会删除，不会给你返回任何东西。

但是这个两个删除也不能及时释放内存的时候，就会走内存淘汰机制。

### 内存淘代机制

**从已经设置过期时间的数据集和在使用的数据集中**

1.  **volatile-lru（least recently used）**：从已设置过期时间的数据集中挑选最近最少使用的数据淘汰
2.  **volatile-ttl**：从已设置过期时间的数据集中挑选将要过期的数据淘汰
3.  **volatile-random**：从已设置过期时间的数据集中任意选择数据淘汰

已设置过期时间的数据集中挑选最近最少使用的数据进行淘汰，从已设置过期时间的数据集中挑选将要过期的数据进行淘汰，从已经设置

5.  **allkeys-lru（least recently used）**：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的 key（这个是最常用的）
6.  **allkeys-random**：从数据集中任意选择数据淘汰

## 持久化

### Redis 持久化的两种方式

-   RDB：RDB 持久化机制，是对 Redis 中的数据执行**周期性**的持久化。
	-   周期性的持久：数据存在一定的丢失，但是恢复数据比较快

-   AOF：AOF 机制对**每条写入命令作为日志**，以 **append-only** **的模式**写入一个日志文件中，在 Redis 重启的时候，可以通过**回放** AOF 日志中的写入指令来重新构建整个数据集。
	-   随着命令越多，体积会越来越大，会有一个瘦身动作，新的AOF文件不会包含任何浪费空间的冗余命令。


### RDB 和 AOF 到底该如何选择

-   Redis 支持同时开启开启两种持久化方式，我们可以综合使用 AOF 和 RDB 两种持久化机制，

AOF 数据比较完整，安全性高，来保证数据不丢失，作为数据恢复的第一选择；缺点；一直往里append导致文件体积大，可以配合RDB来一起

用 RDB 来做不同程度的冷备，在 AOF 文件都丢失或损坏不可用的时候，还可以使用 RDB 来进行快速的数据恢复。
